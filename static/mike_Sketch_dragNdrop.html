<html>
  <head>
    <title>Drag n Drop</title>
    <script>
window.onload = function(){
   
  $      = function(id)  { return document.getElementById(id) } ;
  var dc = function(tag) { return document.createElement(tag) } ;

  var MOUSE = { x:0, y:0, dwn:false, mov:false, sel:false         } ; //mouse state object
  var C     = { canvas:'', w:320, h:240, x:0, y:0                 } ; //canvas object
  var MENU  = { x:0, y:0, active:false, time:0, dur:20, radius:30 } ;

  C.canvas        = dc('canvas')      ;
  C.canvas.id     = 'canvasMT'        ;
  C.canvas.width  = C.w               ;
  C.canvas.height = C.h               ;
  document.body.appendChild(C.canvas) ;

  C.x = C.canvas.offsetLeft ; //delta from x.offsetParent (body)
  C.y = C.canvas.offsetTop  ; //alt = e.offsetX (will tile?)

  var nDRAG = 2  ; //num of draggable objects
  var oDRAG = [] ; //collection of draggable objects
  var oNODE = [] ; //collection of rotateable nodes
  var CTX   = C.canvas.getContext('2d') ;

  function documentMouseMoveHandler(event) {
    MOUSE.mov = true                ;
    MOUSE.x   = event.clientX - C.x ;
    MOUSE.y   = event.clientY - C.y ;
  }

  function documentMouseDownHandler(event) {
    MOUSE.dwn = true  ;
    MOUSE.mov = false ;
    for(var i =0, len = oDRAG.length; i < len; i++){
      if( distanceBetween( oDRAG[i].x, MOUSE.x, oDRAG[i].y, MOUSE.y) < oDRAG[i].radius * 1.5) {
        MOUSE.sel          = oDRAG[i]                ;
        MOUSE.sel.dragging = true                    ;
        MOUSE.sel.color    = 'rgba(255,255,222,1.0)' ;
        break                                        ;
      }
    }
    document.body.style.cursor = 'pointer' ;
  }
  
  function documentMouseUpHandler(event) {
    MENU.active                = false                   ;
    MENU.time                  = 0                       ;
    MOUSE.dwn                  = false                   ;
    MOUSE.sel.dragging         = false                   ;
    MOUSE.sel.color            = 'rgba(222,222,222,1.0)' ;
    MOUSE.sel                  = false                   ;
    document.body.style.cursor = 'default'               ;
  }

  function Node() {
    this.type     = 'Node'                  ;
    this.dragging = false                   ;
    this.angle    = 0                       ;
    this.x        = 0                       ;
    this.y        = 0                       ;
    this.radius   = 10                      ;
    this.length   = 70                      ;
    this.color    = 'rgba(222,222,222,1.0)' ;
    this.text     = 'Insert your message. ' ;

    this.getpin = function(){
      var end   = {x:0, y:0}                                    ;
      end.x     = this.x + (Math.cos(this.angle) * this.length) ;
      end.y     = this.y + (Math.sin(this.angle) * this.length) ;
      return end                                                ;
    }

    this.xform = function(){
      // translation matrix:
      //  1  0  tx              
      //  0  1  ty
      //  0  0  1 
      //CTX.setTransform(1,0,0,1,0,0)                                                                     ; //reset canvas
      CTX.setTransform(Math.cos(this.angle), Math.sin(this.angle), -Math.sin(this.angle), Math.cos(this.angle), this.x, this.y) ;
    }

    this.circle = function(radius, color){
      CTX.fillStyle = color                                                       ;
      CTX.beginPath()                                                             ;
      CTX.arc(0, 0, radius+Math.sin((this.x+this.y) * 0.1)*3, 0, Math.PI*2, true) ;
      CTX.fill()                                                                  ;
    }

    this.menu = function(){
      CTX.fillStyle = '#88D'                                                    ;
      CTX.fillRect(-(this.length*0.5),-(this.radius), this.length, this.radius) ;
      CTX.fillStyle = this.color                                                ;
      CTX.font      = '10pt Helvetica'                                          ;
      CTX.fillText(this.text, -(this.length*0.4),-(this.radius*0.3))            ;
    }

    this.draw = function(){
      this.xform()               ;
      CTX.fillStyle = this.color ;
      if(this.type == 'Node'){
        this.circle(this.radius);
      }
      else if(this.type == 'Segment'){
        var border = this.radius * 0.5                                           ;
        CTX.fillRect(-(border),-(border), this.length +(2* border), this.radius) ;
          //draw pin
        this.circle(this.radius * 0.3, 'rgba(222,222,222,1.0)') ;
        var end = this.getpin()                                 ;
        CTX.setTransform(1,0,0,1,end.x,end.y)                   ;
        this.circle(this.radius * 0.3, 'rgba(222,222,222,1.0)') ;
      }
      else{   //DEBUG : draw magenta square
        CTX.fillStyle = '#F0F'                    ;
        CTX.fillRect(0,0,this.radius,this.radius) ;
      }
    }
  }

  (function(){ 
      // Register event listeners
    document.addEventListener('mousemove' , documentMouseMoveHandler , false ) ;
    document.addEventListener('mousedown' , documentMouseDownHandler , false ) ;
    document.addEventListener('mouseup'   , documentMouseUpHandler   , false ) ;
      // Init objects
    var canvasWD = C.w * 0.5 ;
    var canvasHT = C.h * 0.5 ;

    for(var i=0; i<nDRAG; i++){
      var circle        = new Node()                                                             ;
      var angle_r       = Math.random() * (Math.PI * 2.0)                                        ;
      var radius_r      = Math.random() * Math.min(canvasWD, canvasHT)*Math.min(1.0, 0.15*nDRAG) ;
          circle.x      = Math.cos(angle_r) * radius_r + canvasWD                                ;
          circle.y      = Math.sin(angle_r) * radius_r + canvasHT                                ;
          circle.radius = Math.max(Math.random(), 1.0/nDRAG)*25                                  ;
          circle.text   = 'dragME'                                                               ;
          circle.length = 55                                                                     ;
      oDRAG.push(circle)                                                                         ;
    }
      //generate ik segments
    for(var i=0; i<3; i++){
      var segment   = new Node() ;
      segment.type  = 'Segment'  ;
      segment.color = '#555'     ;
      oNODE.push(segment)        ;
    }
      //generate menu segments
      oNODE[2].x      = canvasWD ;
      oNODE[2].y      = canvasHT ;
      oNODE[2].length = 85       ;
      oNODE[2].radius = 5        ;

    setInterval(update, 20)      ;

  })();

  function update(){
    if(MENU.active == true){
      clearCanvas()                 ;
      oNODE[2].x      = MENU.x      ;
      oNODE[2].y      = MENU.y      ;
      oNODE[2].length = MENU.radius ;
      point_To_Mouse(oNODE[2])      ;
    }
    else{
      clearCanvas() ;
      //position and draw objects
      for(var i =0, len = oDRAG.length; i < len; i++){
        if( oDRAG[i].dragging ) {
          oDRAG[i].x += ( MOUSE.x - oDRAG[i].x ) * 0.2 ;
          oDRAG[i].y += ( MOUSE.y - oDRAG[i].y ) * 0.2 ;
          //prevent out of bounds
          oDRAG[i].x = Math.max( Math.min( oDRAG[i].x, C.w), 0 ) ;
          oDRAG[i].y = Math.max( Math.min( oDRAG[i].y, C.h), 0 ) ;
        }
        CTX.setTransform(1,0,0,1,oDRAG[i].x,oDRAG[i].y) ;
        oDRAG[i].draw()                                 ;
        if( oDRAG[i].dragging ) {
          CTX.setTransform(1,0,0,1,oDRAG[i].x,oDRAG[i].y-oDRAG[i].radius) ;
          oDRAG[i].menu()                                                 ;
        }
      }

      //Draw segment nodes
      oNODE[0].x = oDRAG[0].x                ;
      oNODE[0].y = oDRAG[0].y                ;
      ik_Solve(oNODE[0], oNODE[1], oDRAG[1]) ;

      if(MOUSE.dwn == true){
        if(MOUSE.mov == false){
          MENU.time++; 
          if(MENU.time > MENU.dur){
            debugPrint('Menu!')   ;
            MENU.active = true    ;
            MENU.x      = MOUSE.x ;
            MENU.y      = MOUSE.y ;
          }
          else{
            debugPrint('Hello World '+ MENU.time +' '+ MOUSE.mov +' '+ MOUSE.sel.type +' menu: '+ MENU.active) ;
          }
        }
      }
    }
  } 

  function ik_Solve(ik_0, ik_1, target){
    var dx     = target.x - ik_0.x                 ;
    var dy     = target.y - ik_0.y                 ;
    var dist   = Math.sqrt(dx *dx + dy* dy)        ;
    var a      = ik_0.length                       ;
    var b      = ik_1.length                       ;
    var c      = Math.min(dist, a + b)             ;
    var B      = Math.acos((b*b-a*a-c*c)/(-2*a*c)) ;
    var C      = Math.acos((c*c-a*a-b*b)/(-2*a*b)) ;
    var D      = Math.atan2(dy, dx)                ;
    ik_0.angle = D + B                             ;
    ik_0.draw()                                    ;
    var end    = ik_0.getpin()                     ;
    ik_1.x     = end.x                             ;
    ik_1.y     = end.y                             ;
    ik_1.angle = D + B + Math.PI + C               ;
    ik_1.draw()                                    ;
  }

  function point_To_Mouse(seg){
    var dx    = MOUSE.x - (seg.x)  ;
    var dy    = MOUSE.y - (seg.y)  ;
    seg.angle = Math.atan2(dy, dx) ;
    seg.draw()                     ;
  }

  function distanceBetween(x1,x2,y1,y2) {
    var dx = x1-x2                  ;
    var dy = y1-y2                  ;
    return Math.sqrt(dx*dx + dy*dy) ;
  }

  function debugPrint(text, x, y){
    CTX.setTransform(1,0,0,1,x,y)    ; //reset canvas
    CTX.fillStyle = '#DDD'           ;
    CTX.font      = '10pt Helvetica' ;
    CTX.fillText(text, 0, 0)         ;
  }

  function clearCanvas(){
      //clear canvas
    CTX.setTransform(1,0,0,1,0,0)           ; //reset canvas
    CTX.fillStyle = 'rgba(122,122,122,1.0)' ;
    CTX.fillRect(0, 0, C.w, C.h)            ;
  }
}
 </script>
  </head>
  <body id='body' bgcolor="#AAAAAA" align='center'>
  </body>
</html>
