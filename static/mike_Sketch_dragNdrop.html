<html>
  <head>
    <title>Drag n Drop</title>
    <script>
window.onload = function(){
   
  $                 = function(id)  { return document.getElementById(id) } ;
  var dc            = function(tag) { return document.createElement(tag) } ;

  var canvas        = dc('canvas')            ;
      canvas.id     = 'canvasMT'              ;
  var CANVAS_W      = 320                     ;
  var CANVAS_H      = 240                     ;
      canvas.width  = CANVAS_W                ;
      canvas.height = CANVAS_H                ;
  var CTX           = canvas.getContext('2d') ;
  document.body.appendChild(canvas)           ;

  var CANVAS_X = canvas.offsetLeft ; //delta from x.offsetParent (body)
  var CANVAS_Y = canvas.offsetTop  ; //alt = e.offsetX (will tile?)

  var MOUSE_X   = 0     ;
  var MOUSE_Y   = 0     ;
  var MOUSE_DWN = false ;

  var cDRAG = 3  ; //num of draggable objects
  var oDRAG = [] ;
  var oNODE = [] ;

  function documentMouseMoveHandler(event) {
    MOUSE_X = event.clientX - CANVAS_X; 
    MOUSE_Y = event.clientY - CANVAS_Y;
  }

  function documentMouseDownHandler(event) {
    document.body.style.cursor = 'pointer' ;
    MOUSE_DWN                  = true      ;
    for(var i =0; i < oDRAG.length; i++){
      if( distanceBetween( oDRAG[i].pos, { x: MOUSE_X, y: MOUSE_Y } ) < oDRAG[i].radius * 1.5) {
        oDRAG[i].dragging = true                    ;
        oDRAG[i].color    = 'rgba(255,255,222,1.0)' ;
        break                                       ;
      }
    }
  }
  
  function documentMouseUpHandler(event) {
    document.body.style.cursor = 'default' ;
    MOUSE_DWN                  = false     ;
    for(var i =0; i < oDRAG.length; i++){
      oDRAG[i].dragging = false                   ;
      oDRAG[i].color    = 'rgba(222,222,222,1.0)' ;
    }
  }

  function Node() {
    this.pos      = { x: 0, y: 0 }          ;
    this.angle    = 0                       ;
    this.radius   = 10                      ;
    this.length   = 70                      ;
    this.color    = 'rgba(222,222,222,1.0)' ;
    this.dragging = false                   ;
    this.type     = 'Node'                  ;
    this.draw     = function(){

      if(this.type == 'Node'){
        CTX.beginPath()                                ;
        CTX.fillStyle = this.color                     ;
        CTX.arc(0, 0, this.radius, 0, Math.PI*2, true) ;
        CTX.fill()                                     ;
      }
      else if(this.type == 'Segment'){
        var border    = this.radius * 0.5                                    ;
        CTX.fillStyle = this.color                                           ;
        CTX.fillRect(-(border),-(border), this.length + border, this.radius) ;
      }
      else{   //DEBUG : draw magenta square
        CTX.fillStyle = '#F0F'                    ;
        CTX.fillRect(0,0,this.radius,this.radius) ;
      }

    }
  }

  (function(){ 
      // Register event listeners
    document.addEventListener('mousemove' , documentMouseMoveHandler , false ) ;
    document.addEventListener('mousedown' , documentMouseDownHandler , false ) ;
    document.addEventListener('mouseup'   , documentMouseUpHandler   , false ) ;
      // Init objects
    var canvasWD = CANVAS_W * 0.5;
    var canvasHT = CANVAS_H * 0.5;

    for(var i=0; i<cDRAG; i++){
      var circle        = new Node()                                                             ;
      var angle_r       = Math.random() * (Math.PI * 2.0)                                        ;
      var radius_r      = Math.random() * Math.min(canvasWD, canvasHT)*Math.min(1.0, 0.15*cDRAG) ;
          circle.pos.x  = Math.cos(angle_r) * radius_r + canvasWD                                ;
          circle.pos.y  = Math.sin(angle_r) * radius_r + canvasHT                                ;
          circle.radius = Math.max(Math.random(), 1.0/cDRAG)*25                                  ;
      oDRAG.push(circle)                                                                         ;
    }

    var segment      = new Node() ;
      segment.type   = 'Segment'  ;
      segment.pos.x  = canvasWD   ;
      segment.pos.y  = canvasHT   ;
      segment.radius = 20         ;
      segment.color  = '#555'     ;
    oNODE.push(segment)           ;

    setInterval(update, 20)       ;

  })();

  function update(){
      //clear canvas
    CTX.setTransform(1,0,0,1,0,0)           ; //reset canvas
    CTX.fillStyle = 'rgba(122,122,122,1.0)' ;
    CTX.fillRect(0, 0, CANVAS_W, CANVAS_H)  ;
      //position and draw objects
    for(var i =0; i < oDRAG.length; i++){
      if( oDRAG[i].dragging ) {
        oDRAG[i].pos.x += ( MOUSE_X - oDRAG[i].pos.x ) * 0.2;
        oDRAG[i].pos.y += ( MOUSE_Y - oDRAG[i].pos.y ) * 0.2;
          //prevent out of bounds
        oDRAG[i].pos.x = Math.max( Math.min( oDRAG[i].pos.x, CANVAS_W), 0 );
        oDRAG[i].pos.y = Math.max( Math.min( oDRAG[i].pos.y, CANVAS_H), 0 );
      }
      CTX.setTransform(1,0,0,1,oDRAG[i].pos.x,oDRAG[i].pos.y) ;
      oDRAG[i].draw()                                         ;
    }
      //Draw segment nodes
    for(var i =0; i < oNODE.length; i++){
      var n = oNODE[i];
      if(MOUSE_DWN == true){
        var dx  = MOUSE_X - (n.pos.x) ;
        var dy  = MOUSE_Y - (n.pos.y) ;
        n.angle = Math.atan2(dy, dx)  ;
      }
      CTX.setTransform(Math.cos(n.angle), Math.sin(n.angle), -Math.sin(n.angle), Math.cos(n.angle), n.pos.x, n.pos.y) ;
      n.draw()                                                      ;
        //Draw pins
      var c = new Node()                                            ;
        c.radius = n.radius * 0.3                                   ;
        c.draw()                                                    ;
        var ratio = n.length/(n.length + n.radius * 0.7) * n.length ;
        c.pos.x   = n.pos.x + (Math.cos(n.angle) * ratio)           ;
        c.pos.y   = n.pos.y + (Math.sin(n.angle) * ratio)           ;
        CTX.setTransform(1,0,0,1,c.pos.x,c.pos.y)                   ;
        c.draw()                                                    ;
    }
  } 

  function xform(draw, pos, angle){
    CTX.save();
    //CTX.setTransform(1,0,0,1,pos.x,pos.y); 

    /*
    CTX.fillStyle = color                       ;
    var dx        = MOUSE_X - ( CANVAS_W * 0.5) ;
    var dy        = MOUSE_Y - ( CANVAS_H * 0.5) ;
    var angle     = Math.atan2(dy, dx)          ;
    */
    // translation matrix:
    //  1  0  tx              
    //  0  1  ty
    //  0  0  1 
    //CTX.setTransform(1,0,0,1,0,0)                                                                     ; //reset canvas
    CTX.setTransform(Math.cos(angle), Math.sin(angle), -Math.sin(angle), Math.cos(angle), pos.x, pos.y) ;
    CTX.restore()                                                                                       ;
  }

  function distanceBetween(p1,p2) {
    var dx = p2.x-p1.x              ;
    var dy = p2.y-p1.y              ;
    return Math.sqrt(dx*dx + dy*dy) ;
  }

}
 </script>
  </head>
  <body id='body' bgcolor="#AAAAAA" align='center'>
  </body>
</html>

